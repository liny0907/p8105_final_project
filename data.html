<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Data</title>

<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Home</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="initial_analysis.html">Data Exploration</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Data Analysis
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="test_fei.html">Hypothesis Test</a>
    </li>
    <li>
      <a href="regression_analysis.html">Regression Analysis</a>
    </li>
  </ul>
</li>
<li>
  <a href="Map_of_China.html">Map</a>
</li>
<li>
  <a href="data.html">Data</a>
</li>
<li>
  <a href="report.html">Report</a>
</li>
<li>
  <a href="project_proposal.html">About</a>
</li>
<li>
  <a href="mailto:&lt;ly2565@cumc.columbia.edu&gt;">
    <span class="fa fa-envelope fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/liny0907/p8105_final_project.github.io">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Data</h1>

</div>


<div id="data-sources" class="section level2">
<h2>Data Sources</h2>
<p>The primary data source of this project is the <a href="https://aqicn.org/data-platform/register/">Air Quality Historical Data Platform</a>.<br />
This public dataset collects daily air quality index (AQI) of various pollutants in each city from local weather bureau. All AQI values were calculated using the US EPA standard.<br />
We can search for the name of our target city, and download a csv file containing daily AQI value for past seven years of six kinds of pollutants: PM2.5, PM10, O3, NO2, SO2 and CO. Data for all 100 cities were searched and downloaded manually by all group members.</p>
<p>The data of GDP and population in top 100 Chinese cities in GDP are collected <a href="https://xw.qq.com/partner/vivoscreen/20201004A0BILP/20201004A0BILP00?ADTAG=vivoscreen&amp;%3BvivoRcdMark=1">online</a>. We then create a cvs file containing city name, GDP in billion CNY, and population in thousand.</p>
<p>The daily average temperature data are from <a href="https://www.ncdc.noaa.gov/cdo-web/results">NOAA</a>. We used below code chunk to extract weather data for each city:</p>
<pre class="r"><code>weather_df = 
  rnoaa::meteo_pull_monitors(
    c(&quot;CHM00054511&quot;, &quot;CHM00058362&quot;, &quot;CHM00050953&quot;, &quot;CHM00054342&quot;, &quot;CHM00055591&quot;, &quot;CHM00056294&quot;, &quot;CHM00056778&quot;, &quot;CHM00059287&quot;, &quot;CHM00057036&quot;, &quot;CHM00057494&quot;, &quot;CHM00054161&quot;, &quot;CHM00057687&quot;, &quot;CHM00057515&quot;, &quot;CHM00058847&quot;, &quot;CHM00057816&quot;, &quot;CHM00058321&quot;, &quot;CHM00054823&quot;, &quot;CHM00052889&quot;, &quot;CHM00058606&quot;, &quot;CHM00058238&quot;, &quot;CHM00059431&quot;, &quot;CHM00053698&quot;, &quot;CHM00054527&quot;, &quot;CHM00051463&quot;, &quot;CHM00052866&quot;, &quot;CHM00053614&quot;, &quot;CHM00057083&quot;),
    var = c(&quot;PRCP&quot;, &quot;TAVG&quot;), 
    date_min = &quot;2020-02-01&quot;,
    date_max = &quot;2020-04-30&quot;) %&gt;%
  mutate(
    name = recode(
      id, 
      CHM00054511 = &quot;Beijing&quot;, 
      CHM00058362 = &quot;Shanghai&quot;,
      CHM00050953 = &quot;Harbin&quot;,
      CHM00054342 = &quot;Shenyang&quot;,
      CHM00055591 = &quot;Lhasa&quot;,
      CHM00056294 = &quot;Chengdu&quot;,
      CHM00056778 = &quot;Kunming&quot;,
      CHM00059287 = &quot;Guangzhou&quot;,
      CHM00057036 = &quot;Xian&quot;,
      CHM00057494 = &quot;Wuhan&quot;,
      CHM00054161 = &quot;Changchun&quot;,
      CHM00057687 = &quot;Changsha&quot;,
      CHM00057515 = &quot;Chongqing&quot;,
      CHM00058847 = &quot;Fuzhou&quot;,
      CHM00057816 = &quot;Guiyang&quot;,
      CHM00058321 = &quot;Hefei&quot;,
      CHM00054823 = &quot;Jinan&quot;,
      CHM00052889 = &quot;Lanzhou&quot;,
      CHM00058606 = &quot;Nanchang&quot;,
      CHM00058238 = &quot;Nanjing&quot;,
      CHM00059431 = &quot;Nanning&quot;,
      CHM00053698 = &quot;Shijiazhuang&quot;,
      CHM00053772 = &quot;Taiyuan&quot;,
      CHM00054527 = &quot;Tianjin&quot;,
      CHM00051463 = &quot;Wulumuqi&quot;,
      CHM00052866 = &quot;Xining&quot;,
      CHM00053614 = &quot;Yinchuan&quot;,
      CHM00057083 = &quot;Zhengzhou&quot;),
    tavg = tavg / 10,
    prcp = prcp / 10) %&gt;%
  select(-id) %&gt;% 
  rename(city = name) %&gt;% 
  relocate(city)</code></pre>
</div>
<div id="data-description" class="section level2">
<h2>Data description</h2>
<div id="aqi-data" class="section level3">
<h3>AQI data</h3>
<p>The downloaded AQI files of each city are in two directories: “30_cities_data” contains the 30 major cities that were used for bar graphs, box plots and line charts. The “100_cities_data” contains all 100 cities we downloaded, which were used for creating the interactive map, fitting the regression models and performing statistical tests. Each city’s AQI file is very straightforward. There are only seven variables:<br />
<code>date</code>: The date of the following pollutant’s AQI recordings, in YYYY/MM/DD format.<br />
<code>pm25</code>: The AQI of tiny particles or droplets in the air that are two and one half microns or less in width.<br />
<code>pm10</code>: The AQI of tiny particles or droplets in the air that are 10 microns or less in width.<br />
<code>o3</code>: Ozone’s AQI.<br />
<code>no2</code>: nitrogen dioxide’s AQI<br />
<code>so2</code>: sulfur dioxide’s AQI<br />
<code>co</code>: carbon monoxide’s AQI</p>
<p><a href="https://www.health.ny.gov/environmental/indoors/air/pmq_a.htm#:~:text=The%20term%20fine%20particles%2C%20or,25%2C000%20microns%20in%20an%20inch.">Source of PM 2.5 and PM 10’s definition</a></p>
</div>
<div id="gdp-and-population-data" class="section level3">
<h3>GDP and population data</h3>
<p>The GDP and population dataset contains 4 variables:<br />
<code>rank</code>: a city’s GDP ranking<br />
<code>city</code>: city name<br />
<code>gdp_billion</code>: GDP in billion CHY<br />
<code>population_thousand</code>: population in thousand</p>
</div>
<div id="weather-data" class="section level3">
<h3>Weather data</h3>
<p>The resulting weather dataset contains 4 variables:<br />
<code>city</code>: city name<br />
<code>date</code>: the date that daily average temperature was collected<br />
<code>prcp</code>: precipitation in mm<br />
<code>tavg</code>: daily average temperature</p>
</div>
</div>
<div id="data-cleaning-and-processing" class="section level2">
<h2>Data cleaning and processing</h2>
<p>The daily AQI data of each city was not ordered in time as expected. For example, January 2021 came before December 2021. We used <code>as.Date()</code> to covert all dates into R’s <code>date</code> format, and used the <code>lubridate</code> library and <code>%within%</code> to directly filter out the date period we are interested in.<br />
After some exploratory graphing, We realized that not all pollutants from all time are recorded by each city’s local weather bureau, and we had to change our city selections. For example, we excluded the city “Hangzhou” from out original set of cities, since Hangzhou’s PM2.5 AQI data during the lockdown period was missing. We used another city close to Hangzhou to fill it’s position.</p>
<p>For graph representations, We choose 30 advanced-developed cities in china among the 100 cities. We wrote a function to to pull the filenames of the air quality data from the 30_cities_data directory, and did the same process for 100_cities_data. We also create a data frame named: <code>city_period_diff</code>. It will hold each city’s mean daily AQI difference of each pollutant, between Feb~Aprl 2019 and Feb~Aprl 2020. We used <code>interval()</code> to create time intervals that will be used to extract air quality data from out interested time period: “2018-02-01” ~ “2018-04-30”, “2019-02-01” ~ “2019-04-30”, “2020-02-01” ~ “2020-04-30”, and “2021-02-01” ~ “2021-04-30”.</p>
<pre class="r"><code>city_files = list.files(&quot;30_cities_data&quot;)
onehundrd_city_files = list.files(&quot;100_cities_data&quot;)


city_period_diff = 
  tibble(city = character(),
         pm25 = numeric(),
         pm10 = numeric(),
         o3 = numeric(),
         no2 = numeric(),
         so2 = numeric(),
         co = numeric(),
         )

period_18 = interval(ymd(&quot;2018-02-01&quot;), ymd(&quot;2018-04-30&quot;))
period_19 = interval(ymd(&quot;2019-02-01&quot;), ymd(&quot;2019-04-30&quot;))
period_20 = interval(ymd(&quot;2020-02-01&quot;), ymd(&quot;2020-04-30&quot;))
period_21 = interval(ymd(&quot;2021-02-01&quot;), ymd(&quot;2021-04-30&quot;))</code></pre>
<p>Compute the daily mean pollutant AQI from Feb to Aprl of year 2019 and year 2020 in each city.</p>
<pre class="r"><code>for (city_file in city_files) {
  #print(city_file)
  
  path = str_c(&quot;30_cities_data/&quot;, city_file)
  city = strsplit(city_file, split = &#39;-&#39;)[[1]][1]
  
  cityAir = read_csv(path) %&gt;% 
    mutate(date = as.Date(date, &quot;%Y/%m/%d&quot;)) %&gt;%
    arrange(date)
  
  cityAir_19 = cityAir %&gt;% 
    filter(date %within% period_19) 
  
  cityAir_20 = cityAir %&gt;% 
    filter(date %within% period_20)
  
  
  pm25_19 = mean(cityAir_19$pm25, na.rm = T)
  pm25_20 = mean(cityAir_20$pm25, na.rm = T)
  pm25d = pm25_20 - pm25_19
  
  pm10_19 = mean(cityAir_19$pm10, na.rm = T)
  pm10_20 = mean(cityAir_20$pm10, na.rm = T)
  pm10d = pm10_20 - pm10_19
  
  o3_19 = mean(cityAir_19$o3, na.rm = T)
  o3_20 = mean(cityAir_20$o3, na.rm = T)
  o3d = o3_20 - o3_19
  
  no2_19 = mean(cityAir_19$no2, na.rm = T)
  no2_20 = mean(cityAir_20$no2, na.rm = T)
  no2d = no2_20 - no2_19
  
  so2_19 = mean(cityAir_19$so2, na.rm = T)
  so2_20 = mean(cityAir_20$so2, na.rm = T)
  so2d = so2_20 - so2_19
  
  co_19 = mean(cityAir_19$co, na.rm = T)
  co_20 = mean(cityAir_20$co, na.rm = T)
  cod = co_20 - co_19
  
  city_period_diff = 
    city_period_diff %&gt;% 
    add_row(city = city, 
            pm25 = pm25d,
            pm10 = pm10d,
            o3 = o3d,
            no2 = no2d,
            so2 = so2d,
            co = cod)
}</code></pre>
<p>Then, we transfer the “city” in <code>city_period_diff</code> from the character to factor and make a decreasing sequence by using reorder based on the pm2.5.</p>
<pre class="r"><code>city_period_diff = 
  city_period_diff %&gt;% 
  mutate(
    city = paste(
      toupper(substring(city, 1, 1)), 
      substring(city, 2), 
      sep = &quot;&quot;),
    city = fct_reorder(city, pm25, .desc = T),
    )</code></pre>
<p>Now we will see how the distribution of daily PM25 AQI differ between time period 2019 Feb-Aprl and 2020 Feb~Aprl.</p>
<pre class="r"><code>city_AQI_Distribution = tibble()

for (city_file in city_files) {

  path = str_c(&quot;30_cities_data/&quot;, city_file)
  city = strsplit(city_file, split = &#39;-&#39;)[[1]][1]
  
  cityAir = read_csv(path) %&gt;% 
    mutate(date = as.Date(date, &quot;%Y/%m/%d&quot;)) %&gt;%
    arrange(date)
  
  city_19 = cityAir %&gt;% 
    filter(date %within% period_19) %&gt;% 
    mutate(period = &quot;2019Feb-Aprl&quot;,
           day = format(date,&quot;%m-%d&quot;),
           city = city) %&gt;% 
    relocate(city, period, day)
  
  #add a fake date &quot;2019-02-29&quot; with all AQI values as NA
  city_19 = 
    city_19 %&gt;% 
    add_row(city = city, 
            period = &quot;2019Feb-Aprl&quot;, 
            day = &quot;02-29&quot;) %&gt;% 
    mutate(day = as.factor(day))
  
  
  city_20 = cityAir %&gt;% 
    filter(date %within% period_20) %&gt;% 
    mutate(period = &quot;2020Feb-Aprl&quot;,
           day = format(date,&quot;%m-%d&quot;),
           day = as.factor(day),
           city = city) %&gt;% 
    relocate(city, period, day)
  
  city_AQI_Distribution = rbind(city_AQI_Distribution, city_19)
  city_AQI_Distribution = rbind(city_AQI_Distribution, city_20)
}</code></pre>
<pre class="r"><code>city_AQI_Distribution = 
  city_AQI_Distribution %&gt;% 
  mutate(period = factor(period, levels = c(&quot;2020Feb-Aprl&quot;, &quot;2019Feb-Aprl&quot;)),
         city = paste(
           toupper(substring(city, 1, 1)), 
           substring(city, 2), 
           sep = &quot;&quot;))</code></pre>
<p>In order to see the previous data, we focus on past three years. so we tidy the past Four Years’ Feb~Aprl Mean PM2.5 AQI. The steps are the same as the previous one.</p>
<pre class="r"><code>for (city_file in city_files) {
  #print(city_file)
  
  path = str_c(&quot;30_cities_data/&quot;, city_file)
  city = strsplit(city_file, split = &#39;-&#39;)[[1]][1]
  
  cityAir = read_csv(path) %&gt;% 
    mutate(date = as.Date(date, &quot;%Y/%m/%d&quot;)) %&gt;%
    arrange(date)
  
  cityAir_18 = cityAir %&gt;% 
    filter(date %within% period_18)
  
  cityAir_19 = cityAir %&gt;% 
    filter(date %within% period_19) 
  
  cityAir_20 = cityAir %&gt;% 
    filter(date %within% period_20)
  
  cityAir_21 = cityAir %&gt;% 
    filter(date %within% period_21)
  
  mean_18 = mean(cityAir_18$pm25, na.rm = T)
  mean_19 = mean(cityAir_19$pm25, na.rm = T)
  mean_20 = mean(cityAir_20$pm25, na.rm = T)
  mean_21 = mean(cityAir_21$pm25, na.rm = T)
  
  city_4year_meanPM25 = 
    city_4year_meanPM25 %&gt;%
    add_row(city = city,
            mean_18 = mean_18,
            mean_19 = mean_19, 
            mean_20 = mean_20, 
            mean_21 = mean_21)
}</code></pre>
<pre class="r"><code>city_4year_meanPM25 = 
  city_4year_meanPM25 %&gt;% 
  mutate(city = factor(city)) %&gt;% 
  pivot_longer(
    mean_18:mean_21,
    values_to = &quot;mean&quot;,
    names_to = &quot;years&quot;
  )</code></pre>
<p>Besides analyzing PM2.5, we also want to know how NO2 mean API mean change for four years from Feb to Aprl. The steps for tidying and cleaning data for NO2 are similar.</p>
<pre class="r"><code>city_4year_meanno2 = 
  tibble(city = character(),
         mean_18 = numeric(),
         mean_19 = numeric(),
         mean_20 = numeric(),
         mean_21 = numeric())</code></pre>
<pre class="r"><code>for (city_file in city_files) {
  #print(city_file)
  
  path = str_c(&quot;30_cities_data/&quot;, city_file)
  city = strsplit(city_file, split = &#39;-&#39;)[[1]][1]
  
  cityAir = read_csv(path) %&gt;% 
    mutate(date = as.Date(date, &quot;%Y/%m/%d&quot;)) %&gt;%
    arrange(date)
  
  cityAir_18 = cityAir %&gt;% 
    filter(date %within% period_18)
  
  cityAir_19 = cityAir %&gt;% 
    filter(date %within% period_19) 
  
  cityAir_20 = cityAir %&gt;% 
    filter(date %within% period_20)
  
  cityAir_21 = cityAir %&gt;% 
    filter(date %within% period_21)
  
  mean_18 = mean(cityAir_18$no2, na.rm = T)
  mean_19 = mean(cityAir_19$no2, na.rm = T)
  mean_20 = mean(cityAir_20$no2, na.rm = T)
  mean_21 = mean(cityAir_21$no2, na.rm = T)
  
  city_4year_meanno2 = 
    city_4year_meanno2 %&gt;%
    add_row(city = city,
            mean_18 = mean_18,
            mean_19 = mean_19, 
            mean_20 = mean_20, 
            mean_21 = mean_21)
}</code></pre>
<pre class="r"><code>city_4year_meanno2 = 
  city_4year_meanno2 %&gt;% 
  mutate(city = factor(city)) %&gt;% 
  pivot_longer(
    mean_18:mean_21,
    values_to = &quot;mean&quot;,
    names_to = &quot;years&quot;
  )</code></pre>
<p>In terms of the dataset of GDP and population for regression analysis, we calculate mean PM2.5 AQI (Feb-Apr) in 2019 and 2020 and mean PM2.5 AQI difference (2019 minus 2020) for each top 100 city in GDP. We then use <code>left_join</code> function to join the GDP and population dataset to the mean PM2.5 AQI difference dataset to get the resulting dataset for regression analysis.</p>
<pre class="r"><code>library(tidyverse)
library(ggridges)

theme_set(theme_minimal() + theme(legend.position = &quot;bottom&quot;))

options(
  ggplot2.continuous.colour = &quot;viridis&quot;,
  ggplot2.continuous.fill = &quot;viridis&quot;
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d

city_100_df = 
  tibble(
  file = list.files(&quot;100_cities_data&quot;)) %&gt;% 
  mutate(
    city = str_remove(file, &quot;-air-quality.csv&quot;),
    path = str_c(&quot;100_cities_data/&quot;, file),
    data = map(path, read_csv)
  ) %&gt;% 
  unnest(data) %&gt;% 
  select(-file, -path) %&gt;% 
  mutate(
    city = str_to_title(city),
    date = as.Date(date, format = &quot;%Y/%m/%d&quot;))

pm25_2020 = 
  city_100_df %&gt;% 
  filter(date &gt; &quot;2020-01-31&quot; &amp; date &lt; &quot;2020-05-01&quot;) %&gt;% 
  group_by(city) %&gt;%
  summarize(mean_pm25_2020 = mean(pm25, na.rm = T))
  
pm25_2019 = 
  city_100_df %&gt;% 
  filter(date &gt; &quot;2019-01-31&quot; &amp; date &lt; &quot;2019-05-01&quot;) %&gt;% 
  group_by(city) %&gt;%
  summarize(mean_pm25_2019 = mean(pm25, na.rm = T))

pm25_diff = 
  left_join(pm25_2020, pm25_2019) %&gt;% 
  mutate(pm25_diff = mean_pm25_2019 - mean_pm25_2020)

gdp_pop_df = 
  read_csv(&quot;data/gpd_and_popluation.csv&quot;) %&gt;% 
  janitor::clean_names() %&gt;% 
  mutate(
    gdp_trillion = gdp_billion / 1000,
    pop_million = population_thousand / 1000) %&gt;% 
  select(city, gdp_trillion, pop_million)

diff_gdp_pop_df = 
  left_join(pm25_diff, gdp_pop_df) %&gt;% 
  select(-mean_pm25_2020, -mean_pm25_2019)</code></pre>
<p>For regression of daily PM2.5 vs daily average temperature, we filter PM2.5 AQI from February through April in only 2020 , and collect daily average temperature data during this time period from <strong>NOAA</strong>. We then join them using <code>left_join</code> function.</p>
<pre class="r"><code>weather_df = 
  rnoaa::meteo_pull_monitors(
    c(&quot;CHM00054511&quot;, &quot;CHM00058362&quot;, &quot;CHM00050953&quot;, &quot;CHM00054342&quot;, &quot;CHM00055591&quot;, &quot;CHM00056294&quot;, &quot;CHM00056778&quot;, &quot;CHM00059287&quot;, &quot;CHM00057036&quot;, &quot;CHM00057494&quot;, &quot;CHM00054161&quot;, &quot;CHM00057687&quot;, &quot;CHM00057515&quot;, &quot;CHM00058847&quot;, &quot;CHM00057816&quot;, &quot;CHM00058321&quot;, &quot;CHM00054823&quot;, &quot;CHM00052889&quot;, &quot;CHM00058606&quot;, &quot;CHM00058238&quot;, &quot;CHM00059431&quot;, &quot;CHM00053698&quot;, &quot;CHM00054527&quot;, &quot;CHM00051463&quot;, &quot;CHM00052866&quot;, &quot;CHM00053614&quot;, &quot;CHM00057083&quot;),
    var = c(&quot;PRCP&quot;, &quot;TAVG&quot;), 
    date_min = &quot;2020-02-01&quot;,
    date_max = &quot;2020-04-30&quot;) %&gt;%
  mutate(
    name = recode(
      id, 
      CHM00054511 = &quot;Beijing&quot;, 
      CHM00058362 = &quot;Shanghai&quot;,
      CHM00050953 = &quot;Harbin&quot;,
      CHM00054342 = &quot;Shenyang&quot;,
      CHM00055591 = &quot;Lhasa&quot;,
      CHM00056294 = &quot;Chengdu&quot;,
      CHM00056778 = &quot;Kunming&quot;,
      CHM00059287 = &quot;Guangzhou&quot;,
      CHM00057036 = &quot;Xian&quot;,
      CHM00057494 = &quot;Wuhan&quot;,
      CHM00054161 = &quot;Changchun&quot;,
      CHM00057687 = &quot;Changsha&quot;,
      CHM00057515 = &quot;Chongqing&quot;,
      CHM00058847 = &quot;Fuzhou&quot;,
      CHM00057816 = &quot;Guiyang&quot;,
      CHM00058321 = &quot;Hefei&quot;,
      CHM00054823 = &quot;Jinan&quot;,
      CHM00052889 = &quot;Lanzhou&quot;,
      CHM00058606 = &quot;Nanchang&quot;,
      CHM00058238 = &quot;Nanjing&quot;,
      CHM00059431 = &quot;Nanning&quot;,
      CHM00053698 = &quot;Shijiazhuang&quot;,
      CHM00053772 = &quot;Taiyuan&quot;,
      CHM00054527 = &quot;Tianjin&quot;,
      CHM00051463 = &quot;Wulumuqi&quot;,
      CHM00052866 = &quot;Xining&quot;,
      CHM00053614 = &quot;Yinchuan&quot;,
      CHM00057083 = &quot;Zhengzhou&quot;),
    tavg = tavg / 10,
    prcp = prcp / 10) %&gt;%
  select(-id) %&gt;% 
  rename(city = name) %&gt;% 
  relocate(city)

city_30_df =
  city_100_df %&gt;% 
  filter(date &gt; &quot;2020-01-31&quot; &amp; date &lt; &quot;2020-05-01&quot;) %&gt;% 
  filter(city %in% c(&quot;Beijing&quot;, &quot;Shanghai&quot;, &quot;Harbin&quot;, &quot;Shenyang&quot;, &quot;Lhasa&quot;, &quot;Chengdu&quot;, &quot;Kunming&quot;, &quot;Guangzhou&quot;, &quot;Xian&quot;, &quot;Wuhan&quot;, &quot;Changchun&quot;, &quot;Changsha&quot;, &quot;Chongqing&quot;, &quot;Fuzhou&quot;, &quot;Guiyang&quot;, &quot;Hefei&quot;, &quot;Jinan&quot;, &quot;Lanzhou&quot;, &quot;Nanchang&quot;, &quot;Nanjing&quot;, &quot;Nanning&quot;, &quot;Shijiazhuang&quot;, &quot;Taiyuan&quot;, &quot;Tianjin&quot;, &quot;Wulumuqi&quot;, &quot;Xining&quot;, &quot;Yinchuan&quot;, &quot;Zhengzhou&quot;))

pm25_tavg_df = 
  left_join(city_30_df, weather_df, by = c(&quot;city&quot;, &quot;date&quot;)) %&gt;% 
  arrange(date) %&gt;% 
  select(city, date, pm25, tavg) %&gt;% 
  filter(pm25 != &quot;NA&quot;)</code></pre>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // temporarily add toc-ignore selector to headers for the consistency with Pandoc
    $('.unlisted.unnumbered').addClass('toc-ignore')

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
