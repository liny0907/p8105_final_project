---
title: "Regression Analysis"
author: "Lin Yang"
date: "11/20/2021"
output: github_document
---

```{r, include = FALSE}
library(tidyverse)
library(ggridges)
library(modelr)
library(mgcv)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```
## Create a data frame for regression analysis

Load and clean air quality datasets for 100 cities.
```{r, message = FALSE}
city_100_df = tibble(
  file = list.files("100_cities_data")) %>% 
  mutate(
    city = str_remove(file, "-air-quality.csv"),
    path = str_c("100_cities_data/", file),
    data = map(path, read_csv)
  ) %>% 
  unnest(data) %>% 
  select(-file, -path) %>% 
  mutate(
    city = str_to_title(city),
    date = as.Date(date, format = "%Y/%m/%d"))
```

Select pm2.5 AQI during the lockdown period (Feb-Apr) for both 2019 and 2020.
```{r}
pm25_2020 = 
  city_100_df %>% 
  filter(date > "2020-01-31" & date < "2020-05-01") %>% 
  rename(pm25_2020 = pm25) %>% 
  mutate(date = format(date, format = "%m-%d")) %>% 
  select(city, date, pm25_2020)
  
pm25_2019 = 
  city_100_df %>% 
  filter(date > "2019-01-31" & date < "2019-05-01") %>% 
  rename(pm25_2019 = pm25) %>% 
  mutate(date = format(date, format = "%m-%d")) %>% 
  select(city, date, pm25_2019)

```

Calculate daily pm2.5 AQI differences between 2019 and 2020 for each city.

```{r}
pm25_diff = 
  left_join(pm25_2020, pm25_2019, by = c("city", "date")) %>% 
  drop_na() %>% 
  mutate(pm25_diff = pm25_2019 - pm25_2020) %>% 
  group_by(city) %>% 
  summarize(mean_diff = mean(pm25_diff, na.rm = T))

pm25_diff
```


Load the gdp and population dataset and join it to `pm25_diff`.

```{r, message = FALSE}
gdp_pop_df = 
  read_csv("data/gpd_and_popluation.csv") %>% 
  janitor::clean_names() %>% 
  mutate(pop_ln = log(population_thousand, base = exp(1)),
         gdp_ln = log(gdp_billion, base = exp(1))) %>% 
  select(city, gdp_ln, pop_ln)

diff_gdp_pop_df = left_join(pm25_diff, gdp_pop_df) 
diff_gdp_pop_df
```
We learned that air quality improvement in a city may correlates to the city's GDP and population, so we created a data frame containing mean pm2.5 AQI differences between 2019 and 2020, GDP and population in 2019 for 100 representative cities. The resulting data frame of `diff_gdp_pop_df` contains `r nrow(diff_gdp_pop_df)` observations of `r ncol(diff_gdp_pop_df)` variables. Each row represents one unique city. Below are key variables:
`city`: city name
`mean_diff` mean pm2.5 AQI difference during the lockdown period (Feb-Apr) between 2019 and 2020. 
`gdp_ln`: log of 2019 GDP in billions
`pop_ln`: log of 2019 population in thousands



Fit linear models
## Fit linear models

```{r}
fit = lm(mean_diff ~gdp_ln + pop_ln, data = diff_gdp_pop_df)
summary(fit)

fit %>% 
  broom::tidy() %>% 
  select(term, estimate, p.value) %>% 
  knitr::kable(digit = 3)
```
After fitting a linear model for mean pm2.5 AQI difference dependent on gdp_ln and pop_ln, gdp_ln variable has a slope of -0.894 and pop_ln variable has a slope of 2.903. However, p values of the two linear models are both very large. Therefore, we don't have enough evidence to support that air quality improvement has a linear relation with GDP and population. 

## Model Diagnostics

```{r, warning = FALSE, dpi = 300}
diff_gdp_pop_df %>% 
  modelr::add_residuals(fit) %>% 
  ggplot(aes(x = gdp_ln, y = resid)) + geom_violin()

diff_gdp_pop_df %>% 
  modelr::add_residuals(fit) %>% 
  ggplot(aes(x = pop_ln, y = resid)) + geom_violin()
```

## Cross Validation

Fit three models for `mean_diff` vs. `gdp_ln`.
```{r, warning = FALSE, dpi = 300}
linear_mod_gdp = lm(mean_diff ~ gdp_ln, data = diff_gdp_pop_df)
smooth_mod_gdp = gam(mean_diff ~ s(gdp_ln), data = diff_gdp_pop_df)
wiggly_mod_gdp = gam(mean_diff ~ s(gdp_ln, k = 30), sp = 10e-6, data = diff_gdp_pop_df)
diff_gdp_pop_df %>% 
  gather_predictions(linear_mod_gdp, smooth_mod_gdp, wiggly_mod_gdp) %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = gdp_ln, y = mean_diff)) + 
  geom_point(alpha = .5) +
  geom_line(aes(y = pred), color = "red") + 
  facet_grid(~model) +
  labs(
    x = "log(GDP in Billion)",
    y = "Mean Daily PM2.5 AQI Difference")
```


Fit three models for `mean_diff` vs. `pop_ln`.
```{r, warning = FALSE, dpi = 300}
linear_mod_pop = lm(mean_diff ~ pop_ln, data = diff_gdp_pop_df)
smooth_mod_pop = gam(mean_diff ~ s(pop_ln), data = diff_gdp_pop_df)
wiggly_mod_pop = gam(mean_diff ~ s(pop_ln, k = 30), sp = 10e-6, data = diff_gdp_pop_df)
diff_gdp_pop_df %>% 
  gather_predictions(linear_mod_pop, smooth_mod_pop, wiggly_mod_pop) %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = pop_ln, y = mean_diff)) + 
  geom_point(alpha = .5) +
  geom_line(aes(y = pred), color = "red") + 
  facet_grid(~model) +
  labs(
    x = "log(Population in Thousand)",
    y = "Mean Daily PM2.5 AQI Difference")
```

Cross validation for `mean_diff` vs. `gdp_ln`.
```{r, dpi = 300}
cv_df_gdp = 
  crossv_mc(diff_gdp_pop_df, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)) %>% 
  mutate(
    linear_mod  = map(train, ~lm(mean_diff ~ gdp_ln, data = .x)),
    smooth_mod  = map(train, ~mgcv::gam(mean_diff ~ s(gdp_ln), data = .x)),
    wiggly_mod  = map(train, ~gam(mean_diff ~ s(gdp_ln, k = 30), sp = 10e-6, data = .x))) %>% 
  mutate(
    rmse_linear = map2_dbl(linear_mod, test, ~rmse(model = .x, data = .y)),
    rmse_smooth = map2_dbl(smooth_mod, test, ~rmse(model = .x, data = .y)),
    rmse_wiggly = map2_dbl(wiggly_mod, test, ~rmse(model = .x, data = .y))) %>% 
  select(starts_with("rmse")) %>%
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_") 

cv_df_gdp %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_violin(aes(fill = model), alpha = 0.5) +
  labs(title = "RMSE vs. Model")
```

Cross validation for `mean_diff` vs. `pop_ln`.
```{r, dpi = 300}
cv_df_pop = 
  crossv_mc(diff_gdp_pop_df, 100) %>% 
  mutate(
    train = map(train, as_tibble),
    test = map(test, as_tibble)) %>% 
  mutate(
    linear_mod  = map(train, ~lm(mean_diff ~ pop_ln, data = .x)),
    smooth_mod  = map(train, ~mgcv::gam(mean_diff ~ s(pop_ln), data = .x)),
    wiggly_mod  = map(train, ~gam(mean_diff ~ s(pop_ln, k = 30), sp = 10e-6, data = .x))) %>% 
  mutate(
    rmse_linear = map2_dbl(linear_mod, test, ~rmse(model = .x, data = .y)),
    rmse_smooth = map2_dbl(smooth_mod, test, ~rmse(model = .x, data = .y)),
    rmse_wiggly = map2_dbl(wiggly_mod, test, ~rmse(model = .x, data = .y))) %>% 
  select(starts_with("rmse")) %>%
  pivot_longer(
    everything(),
    names_to = "model", 
    values_to = "rmse",
    names_prefix = "rmse_")

cv_df_pop %>% 
  mutate(model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + 
  geom_violin(aes(fill = model), alpha = 0.5) +
  labs(title = "RMSE vs. Model")
```
We then did cross validation for three different kinds of models of mean PM2.5 difference vs. gdp_ln and pop_ln. The scatterplots indicated that none of the three models were good fits. For both gdp_ln and pop_ln, the distribution of RMSE values for each model suggested that linear and smooth models worked better than wiggly model. But the RMSE values of all the three models were significantly large, confirming all of them were bad fits. 

## Create a data frame containing weather data for regression analysis

Load weather data for 10 representative cities.
```{r, message = FALSE}
weather_df = 
  rnoaa::meteo_pull_monitors(
    c("CHM00054511", "CHM00058362", "CHM00050953", "CHM00054342", "CHM00055591", "CHM00056294", "CHM00056778", "CHM00059287", "CHM00057036", "CHM00057494"),
    var = c("PRCP", "TAVG"), 
    date_min = "2020-02-01",
    date_max = "2020-04-30") %>%
  mutate(
    name = recode(
      id, 
      CHM00054511 = "Beijing", 
      CHM00058362 = "Shanghai",
      CHM00050953 = "Harbin",
      CHM00054342 = "Shenyang",
      CHM00055591 = "Lasa",
      CHM00056294 = "Chengdu",
      CHM00056778 = "Kunming",
      CHM00059287 = "Guangzhou",
      CHM00057036 = "Xian",
      CHM00057494 = "Wuhan"),
    tavg = tavg / 10,
    prcp = prcp / 10) %>%
  select(-id) %>% 
  rename(city = name) %>% 
  relocate(city)

weather_df
```

Join `weather_df` to the AQI dataset of 10 cities.
```{r}
city_10_df =
  city_100_df %>% 
  filter(date > "2020-01-31" & date < "2020-05-01") %>% 
  filter(city %in% c("Beijing", "Shanghai", "Harbin", "Shenyang", "Lasa", "Chengdu", "Kunming", "Guangzhou", "Xian", "Wuhan"))

pm25_tavg_df = 
  left_join(city_10_df, weather_df, by = c("city", "date")) %>% 
  arrange(date) %>% 
  select(city, date, pm25, tavg) %>% 
  drop_na() 

pm25_tavg_df

pm25_tavg_df %>% 
  ggplot(aes(x = tavg, y = pm25)) +
  geom_point() +
  labs(
    x = "Daily Average Temperature",
    y = "Daily PM 2.5 AQI",
    title = "Daily PM 2.5 AQI VS. Daily Average Temperature Feb-Apr in 2020"
  )
```

Fit a linear model.
```{r}
fit2 = lm(pm25 ~tavg, data = pm25_tavg_df)
summary(fit2)
```



