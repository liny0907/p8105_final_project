---
title: "Map"
output: 
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
---

```{r message = FALSE, include = FALSE}
library(tidyverse)
library(lubridate)
library(dplyr)
library(p8105.datasets)
library(leaflet)

theme_set(theme_minimal() + theme(legend.position = "bottom"))

options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_color_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```



# Maps of air pollutants in 100 cities 

### Time period

2019-02-01 to 2019-04-30
           vs
2020-02-01 to 2020-04-30

```{r message = FALSE, include = FALSE}
period_19 = interval(ymd("2019-02-01"), ymd("2019-04-30"))
period_20 = interval(ymd("2020-02-01"), ymd("2020-04-30"))
```


```{r message = FALSE, include = FALSE}
all_cities_files = list.files("100_cities_data")
```


```{r message = FALSE, include = FALSE}
all_city_period_meanPM25 = 
  tibble(city = character(),
         mean_19 = numeric(),
         mean_20 = numeric(),
         mean_diff = numeric())
```

```{r message = FALSE, include = FALSE}
for (city_file in all_cities_files) {
  #print(city_file)
  
  path = str_c("100_cities_data/", city_file)
  city = strsplit(city_file, split = '-')[[1]][1]
  
  cityAir = read_csv(path) %>% 
    mutate(date = as.Date(date, "%Y/%m/%d")) %>%
    arrange(date)
  
  cityAir_19 = cityAir %>% 
    filter(date %within% period_19) 
  
  cityAir_20 = cityAir %>% 
    filter(date %within% period_20)
  
  mean_19 = mean(cityAir_19$pm25, na.rm = T)
  mean_20 = mean(cityAir_20$pm25, na.rm = T)
  mean_diff = mean_20 - mean_19
  
  all_city_period_meanPM25 = 
    all_city_period_meanPM25 %>% 
    add_row(city = city, 
            mean_19 = mean_19, 
            mean_20 = mean_20, 
            mean_diff = mean_diff)
}

```


```{r message = FALSE, include = FALSE}
all_city_period_meanPM25 = 
  all_city_period_meanPM25 %>% 
  mutate(
    city = paste(
      toupper(substring(city, 1, 1)), 
      substring(city, 2), 
      sep = ""),
    city = fct_reorder(city, mean_diff, .desc = T))
```


```{r message = FALSE, include = FALSE}
cities_locations = read_csv("data/100_cities_location.csv")
all_city_period_meanPM25 = merge(all_city_period_meanPM25, cities_locations)
```

```{r message=FALSE}
pal <- colorNumeric(palette = "RdBu", domain = c(-45, 45), reverse = TRUE)

all_city_period_meanPM25 %>% 
  mutate(
    click_label = 
      str_c("<b>", city, 
            "</b><br>19 Daily AQI: ", round(mean_19, digits = 2), 
            "<br>20 Daily AQI: ", round(mean_20, digits = 2),
            "<br>20 Minus 19: ", round(mean_diff, digits = 2))) %>% 
  leaflet(width = "100%") %>% 
  addProviderTiles(providers$Esri.NatGeoWorldMap) %>% 
  addCircleMarkers(~long, ~lat, radius = 3, opacity = 1, color = ~pal(mean_diff), popup = ~click_label)
```

(Note: red indicates deterioration in air quality in 2020 compared to 2019, white indicates no improvement, and blue indicates improvement of air quality in 2020 compared to 2019)

The map of China included in our analysis exhibits the distribution of magnitude of air quality improvement during the lockdown period across 100 cities. Each dot represents a city we selected, and the color indicates its degree of air quality improvement. 

We can see that most cities with significant air quality improvement tend to cluster in the North China and Yangtze River Delta region. This might be partially explained by the economic structure. Industrial output value accounts for a relatively large proportion of GDP in these two areas. Normally, there are a lot of industrial activities going on there. However, during the lockdown period, nearly all of them were partially or completely suspended. As industry does have an unignorable negative impact on air quality, itâ€™s not difficult to see why notable air quality improvement could be observed in these two regions.



